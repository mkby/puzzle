name: Deploy Static Site with GA Injection (Official Method)

on:
  push:
    branches:
      - main  # 仍然监控 main 分支的推送

# 赋予 Actions 部署 Pages 的权限
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  inject_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 1. 检出代码
        uses: actions/checkout@v4

      # ----------------------------------------------
      # 2. 注入 GA ID 步骤 (核心：使用 Secrets)
      # ----------------------------------------------
      - name: 2. 定义 GA 代码块并注入 HTML
        run: |
          # 从 Secrets 中获取 ID
          GA_ID="${{ secrets.GA_MEASUREMENT_ID }}"
          
          # 定义要注入的 GA 代码片段
          GA_SCRIPT="<script async src='https://www.googletagmanager.com/gtag/js?id=$GA_ID'></script>"
          GA_SCRIPT+="\n<script>"
          GA_SCRIPT+="\n  window.dataLayer = window.dataLayer || [];"
          GA_SCRIPT+="\n  function gtag(){dataLayer.push(arguments);}"
          GA_SCRIPT+="\n  gtag('js', new Date());"
          GA_SCRIPT+="\n  gtag('config', '$GA_ID');"
          GA_SCRIPT+="\n</script>"
          
          # 注入操作：将 GA 代码插入到 index.html 的 </head> 标签前
          echo "注入 GA ID: ${{ secrets.GA_MEASUREMENT_ID }}"
          sed -i "/<\/head>/i\ ${{ env.GA_SCRIPT }}" index.html
          
      # ----------------------------------------------
      # 3. 官方部署步骤
      # ----------------------------------------------
      - name: 3. 上传 Pages 制品
        uses: actions/upload-pages-artifact@v3
        with:
          # 将当前目录（已注入 GA ID 的文件）打包
          path: . 

      - name: 4. 部署到 GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
