name: Deploy Static Site with GA Injection (Official Method)

on:
  push:
    tags:
      - 'v*'  # 仅监控标签推送，例如 v1.0.0

# 赋予 Actions 部署 Pages 的权限
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  inject_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 1. 检出代码
        uses: actions/checkout@v4

      - name: 1.5. 注入版本号
        run: |
          # 获取 Tag 和 Commit ID
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            TAG_NAME=${GITHUB_REF#refs/tags/}
            COMMIT_SHORT=$(git rev-parse --short HEAD)
            VERSION_STR="${TAG_NAME}-${COMMIT_SHORT}"
            
            echo "Injecting version: $VERSION_STR"
            # 替换 index.html 中的版本号 (使用 sed)
            sed -i "s/window.APP_VERSION = 'dev';/window.APP_VERSION = '$VERSION_STR';/" index.html
          else
            echo "Not a tag push, skipping version injection"
          fi

      - name: 2. 定义 GA 代码块并注入 HTML
        run: |
          # 从 Secrets 中获取 ID
          GA_ID="${{ secrets.GA_MEASUREMENT_ID }}"
          
          # 定义要注入的 GA 代码片段
          GA_SCRIPT="<script async src='https://www.googletagmanager.com/gtag/js?id=$GA_ID'></script>"
          GA_SCRIPT+="\n<script>"
          GA_SCRIPT+="\n  window.dataLayer = window.dataLayer || [];"
          GA_SCRIPT+="\n  function gtag(){dataLayer.push(arguments);}"
          GA_SCRIPT+="\n  gtag('js', new Date());"
          GA_SCRIPT+="\n  gtag('config', '$GA_ID');"
          GA_SCRIPT+="\n</script>"

          # 将代码块存储为环境变量，供下一步使用
          echo "GA_SCRIPT_ESCAPED<<EOF" >> $GITHUB_ENV
          echo "$GA_SCRIPT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: 3. 将 GA 代码注入 HTML 文件
        run: |
          # 注入操作：将 GA 代码插入到 index.html 的 </head> 标签前
          echo "注入 GA ID: ${{ secrets.GA_MEASUREMENT_ID }}"
          sed -i "/<\/head>/i\ ${{ env.GA_SCRIPT_ESCAPED }}" index.html
          
      - name: 4. 上传 Pages 制品
        uses: actions/upload-pages-artifact@v3
        with:
          # 将当前目录（已注入 GA ID 的文件）打包
          path: . 

      - name: 5. 部署到 GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
